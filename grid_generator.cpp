#include "Grid.h"
#include "LevelSet.h"

static pthread_mutex_t glob_mutex;

void* exec(void* dummy)
{
    int params[][10] = {
      // cnt   grp shp  x  y  mrg +- x/y msc rows
        { 200, 0,  0,   4, 3, 0,  0, 0,  0, 0},
        { 200, 0,  0,   4, 3, 0,  1, 0,  0, 0},
        { 200, 0,  0,   4, 3, 0,  1, 1,  0, 0},
        { 200, 0,  0,   4, 3, 0,  1, 1,  1, 0},
        { 200, 0,  0,   4, 3, 0,  1, 1,  1, 50},
        { 200, 0,  0,   5, 4, 0,  0, 0,  0, 0},
        { 200, 0,  0,   5, 4, 0,  1, 0,  0, 0},
        { 200, 0,  0,   5, 4, 0,  1, 1,  0, 0},
        { 200, 0,  0,   5, 4, 0,  1, 1,  1, 0},
        { 200, 0,  0,   5, 4, 0,  1, 1,  1, 50},
        { 200, 0,  0,   6, 5, 0,  0, 0,  0, 0},
        { 200, 0,  0,   6, 5, 0,  1, 0,  0, 0},
        { 200, 0,  0,   6, 5, 0,  1, 1,  0, 0},
        { 200, 0,  0,   6, 5, 0,  1, 1,  1, 0},
        { 200, 0,  0,   6, 5, 0,  1, 1,  1, 50},
        { 200, 0,  0,   7, 6, 0,  0, 0,  0, 0},
        { 200, 0,  0,   7, 6, 0,  1, 0,  0, 0},
        { 200, 0,  0,   7, 6, 0,  1, 1,  0, 0},
        { 200, 0,  0,   7, 6, 0,  1, 1,  1, 0},
        { 200, 0,  0,   7, 6, 0,  1, 1,  1, 50},
        { 200, 0,  0,   8, 7, 0,  0, 0,  0, 0},
        { 200, 0,  0,   8, 7, 0,  1, 0,  0, 0},
        { 200, 0,  0,   8, 7, 0,  1, 0,  0, 0},
        { 200, 0,  0,   8, 7, 0,  1, 1,  1, 0},
        { 200, 0,  0,   8, 7, 0,  1, 1,  1, 50},
        { 200, 0,  0,   9, 8, 0,  0, 0,  0, 0},
        { 200, 0,  0,   9, 8, 0,  1, 0,  0, 0},
        { 200, 0,  0,   9, 8, 0,  1, 1,  0, 0},
        { 200, 0,  0,   9, 8, 0,  1, 1,  1, 0},
        { 200, 0,  0,   9, 8, 0,  1, 1,  1, 50},

        { 200, 1,  1,   3, 3, 0,  0, 0,  0, 0},
        { 200, 1,  1,   3, 3, 0,  1, 0,  0, 0},
        { 200, 1,  1,   3, 3, 0,  1, 1,  0, 0},
        { 200, 1,  1,   3, 3, 0,  1, 1,  1, 0},
        { 200, 1,  1,   3, 3, 0,  1, 1,  1, 50},
        { 200, 1,  1,   4, 4, 0,  0, 0,  0, 0},
        { 200, 1,  1,   4, 4, 0,  1, 0,  0, 0},
        { 200, 1,  1,   4, 4, 0,  1, 1,  0, 0},
        { 200, 1,  1,   4, 4, 0,  1, 1,  1, 0},
        { 200, 1,  1,   4, 4, 0,  1, 1,  1, 50},
        { 200, 1,  1,   5, 5, 0,  0, 0,  0, 0},
        { 200, 1,  1,   5, 5, 0,  1, 0,  0, 0},
        { 200, 1,  1,   5, 5, 0,  1, 1,  0, 0},
        { 200, 1,  1,   5, 5, 0,  1, 1,  1, 0},
        { 200, 1,  1,   5, 5, 0,  1, 1,  1, 50},
        { 200, 1,  1,   6, 6, 1,  0, 0,  0, 0},
        { 200, 1,  1,   6, 6, 1,  1, 0,  0, 0},
        { 200, 1,  1,   6, 6, 1,  1, 1,  0, 0},
        { 200, 1,  1,   6, 6, 1,  1, 1,  1, 0},
        { 200, 1,  1,   6, 6, 1,  1, 1,  1, 50},
        { 200, 1,  1,   7, 7, 2,  0, 0,  0, 0},
        { 200, 1,  1,   7, 7, 2,  1, 0,  0, 0},
        { 200, 1,  1,   7, 7, 2,  1, 1,  0, 0},
        { 200, 1,  1,   7, 7, 2,  1, 1,  1, 0},
        { 200, 1,  1,   7, 7, 2,  1, 1,  1, 50},
        { 200, 1,  1,   8, 8, 3,  0, 0,  0, 0},
        { 200, 1,  1,   8, 8, 3,  1, 0,  0, 0},
        { 200, 1,  1,   8, 8, 3,  1, 1,  0, 0},
        { 200, 1,  1,   8, 8, 3,  1, 1,  1, 0},
        { 200, 1,  1,   8, 8, 3,  1, 1,  1, 50},

        { 200, 2,  2,   3, 2, 0,  0, 0,  0, 0},
        { 200, 2,  2,   3, 2, 0,  1, 0,  0, 0},
        { 200, 2,  2,   3, 2, 0,  1, 1,  0, 0},
        { 200, 2,  2,   3, 2, 0,  1, 1,  1, 0},
        { 200, 2,  2,   3, 2, 0,  1, 1,  1, 50},
        { 200, 2,  2,   4, 3, 0,  0, 0,  0, 0},
        { 200, 2,  2,   4, 3, 0,  1, 0,  0, 0},
        { 200, 2,  2,   4, 3, 0,  1, 1,  0, 0},
        { 200, 2,  2,   4, 3, 0,  1, 1,  1, 0},
        { 200, 2,  2,   4, 3, 0,  1, 1,  1, 50},
        { 200, 2,  2,   6, 4, 0,  0, 0,  0, 0},
        { 200, 2,  2,   6, 4, 0,  1, 0,  0, 0},
        { 200, 2,  2,   6, 4, 0,  1, 1,  0, 0},
        { 200, 2,  2,   6, 4, 0,  1, 1,  1, 0},
        { 200, 2,  2,   6, 4, 0,  1, 1,  1, 50},
        { 200, 2,  2,   8, 5, 1,  0, 0,  0, 0},
        { 200, 2,  2,   8, 5, 1,  1, 0,  0, 0},
        { 200, 2,  2,   8, 5, 1,  1, 1,  0, 0},
        { 200, 2,  2,   8, 5, 1,  1, 1,  1, 0},
        { 200, 2,  2,   8, 5, 1,  1, 1,  1, 50},
        { 200, 2,  2,   9, 6, 2,  0, 0,  0, 0},
        { 200, 2,  2,   9, 6, 2,  1, 0,  0, 0},
        { 200, 2,  2,   9, 6, 2,  1, 1,  0, 0},
        { 200, 2,  2,   9, 6, 2,  1, 1,  1, 0},
        { 200, 2,  2,   9, 6, 2,  1, 1,  1, 50},
        { 200, 2,  2,  11, 7, 3,  0, 0,  0, 0},
        { 200, 2,  2,  11, 7, 3,  1, 0,  0, 0},
        { 200, 2,  2,  11, 7, 3,  1, 1,  0, 0},
        { 200, 2,  2,  11, 7, 3,  1, 1,  1, 0},
        { 200, 2,  2,  11, 7, 3,  1, 1,  1, 50},


        { 200, 3,  0,   4, 4, 0,  1, 1,  1, -1},
        { 200, 3,  1,   4, 4, 0,  1, 1,  1, -1},
        { 200, 3,  2,   4, 4, 0,  1, 1,  1, -1},
        { 200, 3,  1,   4, 4, 1,  1, 1,  1, -2},
        { 200, 3,  2,   8, 4, 1,  1, 1,  1, -2},
        { 200, 3,  0,   6, 6, 0,  1, 1,  1, -1},
        { 200, 3,  1,   6, 6, 0,  1, 1,  1, -1},
        { 200, 3,  2,   6, 6, 0,  1, 1,  1, -1},
        { 200, 3,  1,   6, 6, 1,  1, 1,  1, -2},
        { 200, 3,  2,  12, 6, 2,  1, 1,  1, -2},
        { 200, 3,  0,   8, 8, 0,  1, 1,  1, -1},
        { 200, 3,  1,   8, 8, 0,  1, 1,  1, -1},
        { 200, 3,  2,   8, 8, 0,  1, 1,  1, -1},
        { 200, 3,  1,   8, 8, 1,  1, 1,  1, -2},
        { 200, 3,  2,  16, 8, 5,  1, 1,  1, -2},

    
        {  -1, -1,  3, 3, 0,  0, 0,  0, 0}
     };
     int i;
     pthread_mutex_lock(&glob_mutex);



    for (int j = 0; j < GLBAL_LEVEL_SETS; j++)
    {
        int cnt = 0;
        for (i = 0; params[i][0] >= 0; i++)
        {
            if (params[i][1] != j)
                continue;
            if (global_level_sets[j].size() <= cnt)
                global_level_sets[j].push_back(new LevelSet());
            while (global_level_sets[j][cnt]->levels.size() < params[i][0])
            {
                printf("%d of %d\n", global_level_sets[j][cnt]->levels.size(), params[i][0]);
                pthread_mutex_unlock(&glob_mutex);
                Grid* g;
                int rn = params[i][2];

                if (rn == 0)
                    g = new HexagonGrid ();
                else if (rn == 1)
                    g = new SquareGrid ();
                else if (rn == 2)
                    g = new TriangleGrid ();
                else
                    assert(0);
                g->randomize(XYPos(params[i][3], params[i][4]), Grid::WrapType((params[i][9] < 0) ? Grid::WrapType(-params[i][9]) : 0), params[i][5], params[i][9] > 0 ? params[i][9] : 0);

                g->make_harder(params[i][6], params[i][7], params[i][7], params[i][8], params[i][8]);
                std::string s = g->to_string();
                {
                    Grid* gt = Grid::Load(s);
                    assert(gt->is_solveable());
                    delete gt;
                }
                pthread_mutex_lock(&glob_mutex);

                std::vector<std::string> &levels = global_level_sets[j][cnt]->levels;
                if(std::find(levels.begin(), levels.end(), s) == levels.end())
                    levels.push_back(s);
                delete g;
                LevelSet::save_global();
                printf("got\n");
            }
            global_level_sets[j][cnt]->levels.resize(params[i][0]);
            cnt++;
        }
        global_level_sets[j].resize(cnt);
        LevelSet::save_global();
    }
    LevelSet::save_global();

    pthread_mutex_unlock(&glob_mutex);
    return NULL;
}


void global_mutex_lock()
{
    pthread_mutex_lock(&glob_mutex);
}

void global_mutex_unlock()
{
    pthread_mutex_unlock(&glob_mutex);
}


int main( int argc, char* argv[] )
{
    //grid_set_rnd(1);
    int TNUM = 8;
    pthread_t thread[TNUM];
    void* dummy;

    LevelSet::init_global();

    // for (int j = 0; j < GLBAL_LEVEL_SETS; j++)
    // {
    //     for (auto a : global_level_sets[j])
    //     {
    //         for (std::string& s : a->levels)
    //         {
    //             std::cout << s << std::endl;
    //             {
    //                 Grid* gt = Grid::Load(s);
    //                 assert(gt->is_solveable());
    //                 delete gt;
    //             }
    //         }
    //     }
    // }

    for (int i = 0; i < TNUM; i++)
        pthread_create(&thread[i], NULL, exec, NULL);
    for (int i = 0; i < TNUM; i++)
        pthread_join(thread[i], &dummy);
    return 0;
}
